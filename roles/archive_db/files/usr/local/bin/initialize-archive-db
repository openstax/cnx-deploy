#!/usr/bin/env python2
from __future__ import print_function

import os
import sys
import argparse
import shlex
from subprocess import PIPE, Popen


# FIXME These initialize tasks run to failures. Ideally, it's be nice if
#       they gracefully bailed out with a meaningful message.
DEPRECATED_EXECUTABLE = "/var/cnx/venvs/archive/bin/cnx-archive-initdb"
DEPRECATED_INIT_DB_CMD = "{} /etc/cnx/archive/app.ini".format(DEPRECATED_EXECUTABLE)

# This message is returned by the initdb command when the database exists.
KNOWN_OK = "Database is already initialized"


def call(cmd):
    """Call a commnd and return the returncode, stdout and stderr."""
    proc = Popen(shlex.split(cmd), stderr=PIPE, stdout=PIPE)
    out, err = proc.communicate()
    return (proc.returncode, out, err,)


def print_issue(step, out, err):
        msg = "Ouch! @ {} \nSTDOUT:\n{}STDERR:\n{}".format(step, out, err)
        print(msg, file=sys.stderr)


def make_parser():
    parser = argparse.ArgumentParser()
    # database arguments
    parser.add_argument('host')
    parser.add_argument('port')
    parser.add_argument('name')
    parser.add_argument('user')
    return parser

def run_cnxdb_cmd(subcmd, args):
    """`subcmd` is the subcommand, something like `init` or `venv`.
    `args` is the parsed args from argparse.
    """
    cmd = "/var/cnx/venvs/archive/bin/cnx-db {1} -h {0.host} -p {0.port} -d {0.name} -U {0.user}".format(args, subcmd)
    retcode, out, err = call(cmd)
    if retcode > 0:
        print_issue(subcmd, out, err)
        sys.exit(1)


def main(argv=None):
    parser = make_parser()
    args = parser.parse_args(argv)

    # Initialize DB
    if os.path.exists(DEPRECATED_EXECUTABLE):
        # FIXME (30-Jan-12017) The cnx-archive-initdb command is deprecated.
        retcode, out, err = call(DEPRECATED_INIT_DB_CMD)
        if retcode > 0 and KNOWN_OK not in err:
            print_issue('initdb', out, err)
            sys.exit(1)
    else:
        run_cnxdb_cmd('init', args)

    # Initialize venv in db
    # FIXME (15-Nov-2016) The venv logic only works with localhost at this time.
    #       It doesn't fail when not localhost, instead it just warns...
    #       As a result, we are temporarily hardcoding this to localhost, which
    #       means archive will be required to be on the same host as postgres.
    #       https://github.com/Connexions/cnx-deploy/issues/145
    run_cnxdb_cmd('venv', args)

    # Database migration happens after cnx-publishing install.
    return 0


if __name__ == '__main__':
    sys.exit(main())
