---

# These directories are used by the document importer
- name: create import build directories
  become: yes
  file:
    path: "{{ item }}"
    state: directory
    mode: 0755
    owner: www-data
    group: www-data
  with_items:
    - /var/local/import-harvest
    - /var/local/import-harvest/latex
    - /var/local/import-harvest/latex/bad
    - /var/local/import-harvest/latex/good
    - /var/local/import-harvest/word
    - /var/local/import-harvest/word/bad
    - /var/local/import-harvest/word/good
  tags:
    - create-import-build-directories

# Install LibreOffice

- name: check for existing libreoffice install
  stat:
    path: "/opt/libreoffice4.1/program/python"
  register: libreoffice_installed_python
  tags:
    - install-libreoffice

- name: unpack libreoffice tarball
  when: "not libreoffice_installed_python.stat.exists"
  unarchive:
    src: "https://packages.cnx.org/deb/LibreOffice_4.1.6.2_Linux_x86-64_deb.tar.gz"
    remote_src: yes
    dest: "/tmp"
  tags:
    - install-libreoffice

- name: install libreoffice
  when: "not libreoffice_installed_python.stat.exists"
  become: yes
  shell: "dpkg -i *.deb"
  args:
    chdir: "/tmp/LibreOffice_4.1.6.2_Linux_x86-64_deb/DEBS/"
  tags:
    - install-libreoffice

- name: install custom unoconv
  become: yes
  get_url:
    dest: /usr/local/bin/unoconv
    force: yes
    url: https://raw.githubusercontent.com/dagwieers/unoconv/master/unoconv
  tags:
    - install-unoconv

# +++
# Configure
# +++

- name: configure zclient in supervisor
  become: yes
  template:
    src: etc/supervisor/conf.d/zclients.conf
    dest: "/etc/supervisor/conf.d/zclients.conf"
    mode: 0644
  register: supervisor_conf_for_zclients
  notify:
    - reload supervisord

- name: restart zclients
  when: "{{ not supervisor_conf_for_zclients|changed }}"
  become: yes
  supervisorctl:
    name: "{{ item }}"
    state: restarted
  with_items: "[{% for i in range(0, hostvars[inventory_hostname].zclient_count|default(1), 1) %}'{{ 'zclient_instance{}'.format(i) }}',{% endfor %}]"
