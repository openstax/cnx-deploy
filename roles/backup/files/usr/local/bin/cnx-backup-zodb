#!/bin/bash

zodb_host=$1

backup_ssh_key=~backup/.ssh/${zodb_host}_id_rsa

# uses a directory relative to the restricted directory specified in the backup user's authorized_keys on the source server
source=zodb/Data.fs

backup_dir=/var/backups/cnx-backups
zodb_dump_base_name=cnx-$zodb_host-Data.fs
zodb_dump_filename=$backup_dir/$zodb_dump_base_name.$(date +%y-%m-%d)

rsync -e "sudo -u backup ssh -o StrictHostKeyChecking=no -i $backup_ssh_key" -a "backup@$zodb_host:$source" "$zodb_dump_filename"
gzip "$zodb_dump_filename"

# save a copy on Amazon AWS S3
/usr/bin/s3cmd put "$zodb_dump_filename.gz" "s3://connexions/backups/$zodb_host/zodb/$zodb_dump_base_name.gz"
