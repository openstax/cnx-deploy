# This configuration is generated by ansible during the playbook's execution.
# The purpose of this configuration is to include one or more ansible
# generated configurations for (e.g. zeo, clients and pdf generation).

[buildout]
extends =
    rhaptos-base.cfg
    libs.cfg
    ansible-versions.cfg

parts +=
    zlibg
    libxml2
    libxslt
    xmlxsl-links
    instance
{% if inventory_hostname in groups.pdf_gen %}
    pdf_gen
{% endif %}
{% if inventory_hostname in groups.zclient %}
{% for i in range(0, hostvars[inventory_hostname].zclient_count|default(1), 1) %}
    instance{{ i }}
{% endfor %}
{% endif %}

# Add additional eggs here
eggs +=
    demjson
    elementtree
    Products.CacheSetup
    Products.CNXCaching
    Products.CNXPloneSite
    Products.CMFDiffTool
    Products.PloneHotfix20110720
    Products.PloneHotfix20110531

backend-ip-address = {{ hostvars[groups.zeo[0]].ansible_default_ipv4.address|default('127.0.0.1') }}

find-links +=
    https://{{ dist_cnx_username }}:{{ dist_cnx_password|urlencode|replace("/", "%2f") }}@dist.cnx.org/packages


[shared]
portal-name = plone

[instance]
zeo-address = {{ hostvars[groups.zeo[0]].ansible_default_ipv4.address }}:${shared:zeo-port}
zope-conf-additional =


[pdf_gen]
<= instance
zope-conf-additional =
    %import Products.ClockServer
    <clock-server>
        method /${shared:portal-name}/queue_tool/clockTick
        period 3
        host 127.0.0.1
        user
        password
    </clock-server>
event-log-custom =
      <logfile>
        path ${buildout:directory}/var/log/pdf_gen.log
        level INFO
      </logfile>
      <syslog>
        address /dev/log
      </syslog>


{% set base_port = zclient_base_port|default(default_zclient_base_port) %}
{% if inventory_hostname in groups.zclient %}
{% for i in range(0, hostvars[inventory_hostname].zclient_count|default(1), 1) %}
[instance{{ i }}]
<= instance
http-address = {{ base_port + i }}
zeo-address = ${buildout:backend-ip-address}:${shared:zeo-port}
event-log-custom =
      <logfile>
        path ${buildout:directory}/var/log/instance{{ i }}.log
        level INFO
      </logfile>
      <syslog>
        address /dev/log
      </syslog>

{% endfor %}
{% endif %}
